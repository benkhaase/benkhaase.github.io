<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hierarchical Budget Tracker</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 20px;
      background-color: #fafafa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    h1, h2 {
      text-align: center;
      margin-top: 20px;
      color: #333;
    }
    .container-custom {
      max-width: 1100px;
      margin: 0 auto;
    }
    /* Pastel backgrounds for categories */
    .main-category {
      background-color: #e6f7ff; /* light pastel blue */
      font-weight: bold;
    }
    .subcategory {
      background-color: #fff9e6; /* light pastel yellow */
      font-size: 0.9em;
    }
    /* Ensure first column cells are left aligned */
    #budgetTable td:first-child {
      text-align: left;
    }
    /* Add some spacing for subcategory cells */
    .subcategory td:first-child {
      padding-left: 30px;
    }
    /* Button styling adjustments */
    .small-btn {
      font-size: 0.8rem;
      padding: 2px 6px;
      margin-left: 5px;
    }
    /* Center table text except for first column */
    #budgetTable td:not(:first-child) {
      text-align: center;
    }
    /* Additional pastel accent colors for charts etc. if needed */
  </style>
</head>
<body>
  <div class="container-custom">
    <h1>My Budget Tracker</h1>

    <!-- Month Selector -->
    <div class="text-center mb-3">
      <label for="selectedMonth" class="form-label">Select Budget Month:</label>
      <input type="month" id="selectedMonth" class="form-control d-inline-block" style="width: auto;" />
    </div>

    <!-- Budget Allocation Table -->
    <h2>Budget Allocations</h2>
    <div>
      <table class="table table-bordered" id="budgetTable">
        <thead class="table-dark">
          <tr>
            <th>Category</th>
            <th>Target</th>
            <th>Money Left Over</th>
          </tr>
        </thead>
        <tbody id="budgetTableBody">
          <!-- Main category & subcategory rows (plus Totals) will be inserted dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Transaction Form -->
    <h2>Add a Transaction</h2>
    <div>
      <form id="transactionForm">
        <div class="mb-3">
          <label for="transactionName" class="form-label">Transaction Name</label>
          <input type="text" class="form-control" id="transactionName" placeholder="e.g., Grocery Run" required />
        </div>
        <div class="mb-3">
          <label for="transactionCategory" class="form-label">Category</label>
          <select class="form-select" id="transactionCategory" required>
            <option value="">-- Select Category --</option>
            <!-- Options added dynamically (format: "Main" or "Main > Sub") -->
          </select>
        </div>
        <div class="mb-3">
          <label for="transactionAmount" class="form-label">Amount</label>
          <input type="number" step="0.01" class="form-control" id="transactionAmount" placeholder="e.g., 50.00" required />
        </div>
        <div class="mb-3">
          <label for="transactionDate" class="form-label">Date</label>
          <input type="date" class="form-control" id="transactionDate" required />
        </div>
        <button type="submit" class="btn btn-primary">Add Transaction</button>
      </form>
    </div>

    <!-- Charts -->
    <h2>Budget vs. Spent Overview</h2>
    <div class="charts-container">
      <div class="chart-box">
        <canvas id="budgetChart"></canvas>
      </div>
      <div class="chart-box">
        <canvas id="spentChart"></canvas>
      </div>
    </div>

    <!-- Additional Pie Charts for Past 3 and 12 Months -->
    <h2>Spending Over Time</h2>
    <div class="charts-container">
      <div class="chart-box">
        <canvas id="spentChart3"></canvas>
        <p class="text-center">Past 3 Months</p>
      </div>
      <div class="chart-box">
        <canvas id="spentChart12"></canvas>
        <p class="text-center">Past 12 Months</p>
      </div>
    </div>

    <!-- Monthly/Yearly Summaries -->
    <div>
      <h2>Spending Summaries</h2>
      <p><strong>This Month’s Total Spent:</strong> $<span id="monthlySpent">0.00</span></p>
      <p><strong>This Year’s Total Spent:</strong> $<span id="yearlySpent">0.00</span></p>
    </div>

    <!-- Transaction History -->
    <div>
      <h2>Transaction History</h2>
      <table class="table table-striped" id="transactionsTable">
        <thead class="table-dark">
          <tr>
            <th>Transaction Name</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Transactions inserted dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Category Transactions Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">Transactions for Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-striped" id="categoryTransactionsTable">
            <thead class="table-dark">
              <tr>
                <th>Transaction Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Category-specific transactions inserted dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Transaction Modal -->
  <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editTransactionForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editTransactionId" />
            <div class="mb-3">
              <label for="editTransactionName" class="form-label">Transaction Name</label>
              <input type="text" class="form-control" id="editTransactionName" required />
            </div>
            <div class="mb-3">
              <label for="editTransactionCategory" class="form-label">Category</label>
              <select class="form-select" id="editTransactionCategory" required>
                <!-- Options inserted dynamically -->
              </select>
            </div>
            <div class="mb-3">
              <label for="editTransactionAmount" class="form-label">Amount</label>
              <input type="number" step="0.01" class="form-control" id="editTransactionAmount" required />
            </div>
            <div class="mb-3">
              <label for="editTransactionDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="editTransactionDate" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-danger" id="deleteTransactionBtn">Delete Transaction</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /******************************************
     * Global Data & Initialization Variables *
     ******************************************/
    // Default hierarchical budget data.
    const defaultBudgetData = [
      { 
        category: 'Housing', allocation: 2300, 
        subcategories: [
          { category: 'Mortgage', allocation: 1631.82 },
          { category: 'HOA', allocation: 486.56 },
          { category: 'Electric', allocation: 63.26 },
          { category: 'Wifi', allocation: 55.00 }
        ]
      },
      { 
        category: 'Debt', allocation: 720, 
        subcategories: [
          { category: "Bens Student Loans", allocation: 269.19 },
          { category: "White Car", allocation: 450 }
        ]
      },
      { 
        category: 'Insurance', allocation: 90, 
        subcategories: [
          { category: "White Car", allocation: 121.00 }
        ]
      },
      { category: 'Charging', allocation: 160 },
      { category: 'Groceries', allocation: 400 },
      { category: 'Restaurants', allocation: 200 },
      { category: 'Shopping', allocation: 100 },
      { 
        category: 'Subscriptions', allocation: 250, 
        subcategories: [
          { category: "Spotify", allocation: 19.99 },
          { category: "FSD", allocation: 107.00 },
          { category: "icloud", allocation: 2.99 },
          { category: "Yoga", allocation: 119.00 }
        ]
      },
      { category: 'House Fund', allocation: 100 },
      { category: 'Maya Fund', allocation: 100 },
      { category: 'Ben Fund', allocation: 100 },
      { category: 'Misc', allocation: 200 }
    ];

    // Global variables to hold the current month’s budget structure.
    let budgetData = []; 
    // For spending totals per category (main and subcategories, with sub keys as "Main > Sub")
    let spentData = {}; 
    // Mapping for current targets.
    let allocations = {}; 
    // References to "Money Left Over" cells.
    const leftoverCells = {};
    let totalsLeftoverCell = null;
    let totalsAllocCell = null; 

    // Chart variables
    let budgetChart, spentChart, spentChart3, spentChart12;

    // DOM element references
    const budgetTableBody = document.getElementById('budgetTableBody');
    const transactionCategorySelect = document.getElementById('transactionCategory');
    const monthInput = document.getElementById('selectedMonth');

    // Set month selector to current month if not set.
    const now = new Date();
    if (!monthInput.value) { monthInput.value = now.toISOString().slice(0, 7); }

    // ------------------------------
    // Utility: Get Selected Month & Year
    // ------------------------------
    function getSelectedMonthYear() {
      const value = monthInput.value;
      if (value) {
        const [year, month] = value.split('-');
        return { year: parseInt(year), month: parseInt(month) - 1 };
      }
      return { year: now.getFullYear(), month: now.getMonth() };
    }

    // ------------------------------
    // Local Storage: Budget Targets
    // ------------------------------
    function loadBudgetTargets() {
      const key = 'budgetTargets_' + monthInput.value;
      const stored = localStorage.getItem(key);
      if (stored) return JSON.parse(stored);
      else {
        let structure = {};
        defaultBudgetData.forEach(item => {
          if (item.subcategories) {
            structure[item.category] = {};
            item.subcategories.forEach(sub => {
              structure[item.category][sub.category] = sub.allocation;
            });
          } else {
            structure[item.category] = item.allocation;
          }
        });
        return structure;
      }
    }
    function saveBudgetTargets(structure) {
      const key = 'budgetTargets_' + monthInput.value;
      localStorage.setItem(key, JSON.stringify(structure));
    }

    // ------------------------------
    // Build Hierarchical Budget Data & Update Budget Table
    // ------------------------------
    function initBudget() {
      const stored = loadBudgetTargets();
      budgetData = [];
      defaultBudgetData.forEach(item => {
        if (typeof stored[item.category] === 'number') {
          budgetData.push({ category: item.category, target: parseFloat(stored[item.category]), subcategories: null });
        } else if (typeof stored[item.category] === 'object') {
          let subcats = [];
          let sum = 0;
          for (const sub in stored[item.category]) {
            const val = parseFloat(stored[item.category][sub]);
            subcats.push({ category: sub, target: val });
            sum += val;
          }
          budgetData.push({ category: item.category, target: sum, subcategories: subcats });
        } else {
          if (item.subcategories) {
            let subcats = [];
            let sum = 0;
            item.subcategories.forEach(sub => {
              subcats.push({ category: sub.category, target: sub.allocation });
              sum += sub.allocation;
            });
            budgetData.push({ category: item.category, target: sum, subcategories: subcats });
          } else {
            budgetData.push({ category: item.category, target: item.allocation, subcategories: null });
          }
        }
      });

      // Clear table and dropdowns.
      budgetTableBody.innerHTML = '';
      transactionCategorySelect.innerHTML = '<option value="">-- Select Category --</option>';
      addOptionToSelect(document.getElementById('editTransactionCategory'), "dummy");

      // Loop through main categories.
      budgetData.forEach(main => {
        // MAIN CATEGORY ROW
        allocations[main.category] = main.target;
        let mainRow = budgetTableBody.insertRow();
        mainRow.classList.add("main-category");
        let mainCell = mainRow.insertCell();
        mainCell.textContent = main.category;
        mainCell.classList.add("clickable");
        mainCell.addEventListener('click', () => showCategoryTransactions(main.category));
        let mainTargetCell = mainRow.insertCell();
        mainTargetCell.textContent = `$${main.target.toFixed(2)}`;
        if (!main.subcategories) {
          mainTargetCell.innerHTML += ' <span class="edit-icon" title="Edit Target">✎</span>';
          mainTargetCell.querySelector('.edit-icon').addEventListener('click', (e) => {
            e.stopPropagation();
            editBudgetTarget(main.category, null);
          });
        }
        let mainLeftoverCell = mainRow.insertCell();
        mainLeftoverCell.textContent = `$${main.target.toFixed(2)}`;
        leftoverCells[main.category] = mainLeftoverCell;
        addOptionToSelect(transactionCategorySelect, main.category);
        addOptionToSelect(document.getElementById('editTransactionCategory'), main.category);

        // SUBCATEGORY ROWS (if any)
        if (main.subcategories) {
          main.subcategories.forEach(sub => {
            let key = `${main.category} > ${sub.category}`;
            allocations[key] = sub.target;
            let subRow = budgetTableBody.insertRow();
            subRow.classList.add("subcategory");
            let subCell = subRow.insertCell();
            // Display subcategory name offset to the right.
            subCell.textContent = sub.category;
            subCell.classList.add("clickable");
            subCell.addEventListener('click', () => showCategoryTransactions(key));
            // Add an "Auto Add" button next to the subcategory name.
            let addBtn = document.createElement("button");
            addBtn.className = "btn btn-primary btn-sm small-btn";
            addBtn.textContent = "Auto Add";
            addBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              autoCreateSubcategoryTransaction(main.category, sub.category, sub.target);
            });
            subCell.appendChild(addBtn);

            let subTargetCell = subRow.insertCell();
            subTargetCell.innerHTML = `$${sub.target.toFixed(2)} <span class="edit-icon" title="Edit Subcategory Target">✎</span>`;
            subTargetCell.querySelector('.edit-icon').addEventListener('click', (e) => {
              e.stopPropagation();
              editBudgetTarget(main.category, sub.category);
            });
            let subLeftoverCell = subRow.insertCell();
            subLeftoverCell.textContent = `$${sub.target.toFixed(2)}`;
            leftoverCells[key] = subLeftoverCell;
            addOptionToSelect(transactionCategorySelect, key);
            addOptionToSelect(document.getElementById('editTransactionCategory'), key);
          });
        }
      });

      // Append Totals row (for main categories only).
      let totalsRow = budgetTableBody.insertRow();
      totalsRow.id = 'totalsRow';
      let labelCell = totalsRow.insertCell();
      labelCell.textContent = 'Totals';
      let totalAllocCell = totalsRow.insertCell();
      let totalAllocations = budgetData.reduce((sum, main) => sum + main.target, 0);
      totalAllocCell.textContent = `$${totalAllocations.toFixed(2)}`;
      totalsAllocCell = totalAllocCell;
      totalsLeftoverCell = totalsRow.insertCell();
      totalsLeftoverCell.id = 'totalsLeftover';
      totalsLeftoverCell.textContent = `$${totalAllocations.toFixed(2)}`;
    }

    function addOptionToSelect(selectElem, category) {
      if (![...selectElem.options].some(opt => opt.value === category)) {
        let option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        selectElem.appendChild(option);
      }
    }

    // ------------------------------
    // Editing Budget Targets
    // ------------------------------
    function editBudgetTarget(mainCategory, subCategory) {
      if (subCategory === null) {
        let mainObj = budgetData.find(item => item.category === mainCategory);
        const current = mainObj.target;
        const newVal = prompt(`Enter new target for ${mainCategory}:`, current);
        if (newVal !== null) {
          const parsed = parseFloat(newVal);
          if (!isNaN(parsed) && parsed >= 0) {
            mainObj.target = parsed;
            let stored = loadBudgetTargets();
            stored[mainCategory] = parsed;
            saveBudgetTargets(stored);
            renderTransactions();
            initBudget();
          } else alert("Please enter a valid number.");
        }
      } else {
        let mainObj = budgetData.find(item => item.category === mainCategory);
        if (!mainObj || !mainObj.subcategories) return;
        let subObj = mainObj.subcategories.find(s => s.category === subCategory);
        const current = subObj.target;
        const newVal = prompt(`Enter new target for ${mainCategory} > ${subCategory}:`, current);
        if (newVal !== null) {
          const parsed = parseFloat(newVal);
          if (!isNaN(parsed) && parsed >= 0) {
            subObj.target = parsed;
            let newMainTotal = mainObj.subcategories.reduce((sum, s) => sum + s.target, 0);
            mainObj.target = newMainTotal;
            let stored = loadBudgetTargets();
            if (typeof stored[mainCategory] === 'object') {
              stored[mainCategory][subCategory] = parsed;
            }
            saveBudgetTargets(stored);
            renderTransactions();
            initBudget();
          } else alert("Please enter a valid number.");
        }
      }
    }

    // ------------------------------
    // Auto-create Transaction for a Subcategory
    // ------------------------------
    function autoCreateSubcategoryTransaction(mainCategory, subCategory, amount) {
      const today = new Date().toISOString().split('T')[0];
      const transaction = {
        id: Date.now().toString(),
        name: `Auto: ${subCategory}`,
        category: `${mainCategory} > ${subCategory}`,
        amount: amount,
        date: today
      };
      let transactions = loadTransactions();
      transactions.push(transaction);
      saveTransactions(transactions);
      renderTransactions();
    }

    // ------------------------------
    // Local Storage: Transactions
    // ------------------------------
    function loadTransactions() {
      const stored = localStorage.getItem('transactions');
      return stored ? JSON.parse(stored) : [];
    }
    function saveTransactions(transactions) {
      localStorage.setItem('transactions', JSON.stringify(transactions));
    }

    // ------------------------------
    // Rendering Transactions & Summaries
    // ------------------------------
    function renderTransactions() {
      const { month: selMonth, year: selYear } = getSelectedMonthYear();
      const allTransactions = loadTransactions();
      const monthlyTransactions = filterTransactionsByMonth(allTransactions, selMonth, selYear);

      // Reset spentData.
      budgetData.forEach(main => {
        spentData[main.category] = 0;
        if (main.subcategories) {
          main.subcategories.forEach(sub => {
            spentData[`${main.category} > ${sub.category}`] = 0;
          });
        }
      });

      const transactionsTableBody = document.getElementById('transactionsTable').querySelector('tbody');
      transactionsTableBody.innerHTML = '';
      monthlyTransactions.forEach(tx => {
        let txCategory = tx.category;
        let mainCat = txCategory.includes(" > ") ? txCategory.split(" > ")[0] : txCategory;
        if (spentData[mainCat] === undefined) spentData[mainCat] = 0;
        spentData[mainCat] += tx.amount;
        if (txCategory.includes(" > ")) {
          spentData[txCategory] += tx.amount;
        }
        let row = transactionsTableBody.insertRow();
        row.insertCell().textContent = tx.name;
        row.insertCell().textContent = tx.category;
        row.insertCell().textContent = `$${tx.amount.toFixed(2)}`;
        row.insertCell().textContent = tx.date;
        let actionsCell = row.insertCell();
        let editBtn = document.createElement('button');
        editBtn.className = 'btn btn-secondary btn-sm small-btn';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => openEditTransactionModal(tx.id));
        actionsCell.appendChild(editBtn);
      });

      // Update leftover cells.
      budgetData.forEach(main => {
        let mainLeftover = main.target - (spentData[main.category] || 0);
        leftoverCells[main.category].textContent = `$${mainLeftover.toFixed(2)}`;
        if (mainLeftover < 0) leftoverCells[main.category].classList.add('over-budget');
        else leftoverCells[main.category].classList.remove('over-budget');
        if (main.subcategories) {
          main.subcategories.forEach(sub => {
            let key = `${main.category} > ${sub.category}`;
            let subLeftover = sub.target - (spentData[key] || 0);
            leftoverCells[key].textContent = `$${subLeftover.toFixed(2)}`;
            if (subLeftover < 0) leftoverCells[key].classList.add('over-budget');
            else leftoverCells[key].classList.remove('over-budget');
          });
        }
      });

      // Update Totals row.
      let totalTarget = 0, totalLeftover = 0;
      budgetData.forEach(main => {
        totalTarget += main.target;
        totalLeftover += main.target - (spentData[main.category] || 0);
      });
      totalsAllocCell.textContent = `$${totalTarget.toFixed(2)}`;
      totalsLeftoverCell.textContent = `$${totalLeftover.toFixed(2)}`;

      // Update charts.
      createSpentChart();
      createSpentChart3();
      createSpentChart12();
      updateSummaries(allTransactions, monthlyTransactions, selYear);
    }

    function filterTransactionsByMonth(transactions, month, year) {
      return transactions.filter(tx => {
        let txDate = new Date(tx.date);
        return (txDate.getMonth() === month && txDate.getFullYear() === year);
      });
    }

    function updateSummaries(allTransactions, monthlyTransactions, selectedYear) {
      const monthlySpentElem = document.getElementById('monthlySpent');
      const yearlySpentElem = document.getElementById('yearlySpent');
      let monthlyTotal = monthlyTransactions.reduce((sum, tx) => sum + tx.amount, 0);
      let yearlyTotal = allTransactions.filter(tx => new Date(tx.date).getFullYear() === selectedYear)
                                       .reduce((sum, tx) => sum + tx.amount, 0);
      monthlySpentElem.textContent = monthlyTotal.toFixed(2);
      yearlySpentElem.textContent = yearlyTotal.toFixed(2);
    }

    // ------------------------------
    // Pie Charts (Aggregated by Main Category)
    // ------------------------------
    function createBudgetChart() {
      const ctxBudget = document.getElementById('budgetChart').getContext('2d');
      if (budgetChart) budgetChart.destroy();
      const labels = budgetData.map(main => main.category);
      const dataAllocations = budgetData.map(main => main.target);
      budgetChart = new Chart(ctxBudget, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Budget Allocation',
            data: dataAllocations,
            backgroundColor: [
              '#a2d5f2', '#ffb3ba', '#ffdfba', '#ffffba',
              '#baffc9', '#bae1ff', '#fbc4ab', '#f6eac2',
              '#c1c8e4', '#d4a5a5', '#f5d0a9', '#b8e0d2'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Budget Distribution (Targets)' }
          }
        }
      });
    }

    function createSpentChart() {
      const ctxSpent = document.getElementById('spentChart').getContext('2d');
      if (spentChart) spentChart.destroy();
      const labels = budgetData.map(main => main.category);
      const dataSpent = budgetData.map(main => spentData[main.category] || 0);
      spentChart = new Chart(ctxSpent, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Spent (This Month)',
            data: dataSpent,
            backgroundColor: [
              '#a2d5f2', '#ffb3ba', '#ffdfba', '#ffffba',
              '#baffc9', '#bae1ff', '#fbc4ab', '#f6eac2',
              '#c1c8e4', '#d4a5a5', '#f5d0a9', '#b8e0d2'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Spent Distribution (This Month)' }
          }
        }
      });
    }

    function calcSpentOverPeriod(startDate, endDate) {
      const transactions = loadTransactions();
      const periodTotals = {};
      budgetData.forEach(main => { periodTotals[main.category] = 0; });
      transactions.forEach(tx => {
        let txDate = new Date(tx.date);
        if (txDate >= startDate && txDate <= endDate) {
          let mainCat = tx.category.includes(" > ") ? tx.category.split(" > ")[0] : tx.category;
          if (periodTotals.hasOwnProperty(mainCat)) { periodTotals[mainCat] += tx.amount; }
        }
      });
      return periodTotals;
    }

    function createSpentChart3() {
      const { year, month } = getSelectedMonthYear();
      const startDate = new Date(year, month - 2, 1);
      const endDate = new Date(year, month + 1, 0);
      const periodTotals = calcSpentOverPeriod(startDate, endDate);
      const labels = budgetData.map(main => main.category);
      const dataSpent = labels.map(cat => periodTotals[cat] || 0);
      const ctx3 = document.getElementById('spentChart3').getContext('2d');
      if (spentChart3) spentChart3.destroy();
      spentChart3 = new Chart(ctx3, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Spent (Past 3 Months)',
            data: dataSpent,
            backgroundColor: [
              '#a2d5f2', '#ffb3ba', '#ffdfba', '#ffffba',
              '#baffc9', '#bae1ff', '#fbc4ab', '#f6eac2',
              '#c1c8e4', '#d4a5a5', '#f5d0a9', '#b8e0d2'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Spent Distribution (Past 3 Months)' }
          }
        }
      });
    }

    function createSpentChart12() {
      const { year, month } = getSelectedMonthYear();
      const startDate = new Date(year, month - 11, 1);
      const endDate = new Date(year, month + 1, 0);
      const periodTotals = calcSpentOverPeriod(startDate, endDate);
      const labels = budgetData.map(main => main.category);
      const dataSpent = labels.map(cat => periodTotals[cat] || 0);
      const ctx12 = document.getElementById('spentChart12').getContext('2d');
      if (spentChart12) spentChart12.destroy();
      spentChart12 = new Chart(ctx12, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Spent (Past 12 Months)',
            data: dataSpent,
            backgroundColor: [
              '#a2d5f2', '#ffb3ba', '#ffdfba', '#ffffba',
              '#baffc9', '#bae1ff', '#fbc4ab', '#f6eac2',
              '#c1c8e4', '#d4a5a5', '#f5d0a9', '#b8e0d2'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Spent Distribution (Past 12 Months)' }
          }
        }
      });
    }

    // ------------------------------
    // Category Modal: Show Transactions
    // ------------------------------
    function showCategoryTransactions(category) {
      const { month: selMonth, year: selYear } = getSelectedMonthYear();
      const allTransactions = loadTransactions();
      const monthlyTransactions = filterTransactionsByMonth(allTransactions, selMonth, selYear);
      let filtered;
      if (category.includes(" > ")) {
        filtered = monthlyTransactions.filter(tx => tx.category === category);
      } else {
        filtered = monthlyTransactions.filter(tx => tx.category === category || tx.category.startsWith(category + " >"));
      }
      document.getElementById('categoryModalLabel').textContent = `Transactions for ${category} (${monthInput.value})`;
      const modalTableBody = document.getElementById('categoryTransactionsTable').querySelector('tbody');
      modalTableBody.innerHTML = '';
      if (filtered.length === 0) {
        let row = modalTableBody.insertRow();
        let cell = row.insertCell();
        cell.colSpan = 4;
        cell.textContent = "No transactions for this category this month.";
        cell.classList.add('text-center');
      } else {
        filtered.forEach(tx => {
          let row = modalTableBody.insertRow();
          row.insertCell().textContent = tx.name;
          row.insertCell().textContent = `$${tx.amount.toFixed(2)}`;
          row.insertCell().textContent = tx.date;
          let actionsCell = row.insertCell();
          let editBtn = document.createElement('button');
          editBtn.className = 'btn btn-secondary btn-sm small-btn';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => openEditTransactionModal(tx.id));
          actionsCell.appendChild(editBtn);
        });
      }
      new bootstrap.Modal(document.getElementById('categoryModal')).show();
    }

    // ------------------------------
    // Transaction Editing
    // ------------------------------
    function openEditTransactionModal(id) {
      let transactions = loadTransactions();
      let tx = transactions.find(t => t.id === id);
      if (!tx) return;
      document.getElementById('editTransactionId').value = tx.id;
      document.getElementById('editTransactionName').value = tx.name;
      document.getElementById('editTransactionCategory').value = tx.category;
      document.getElementById('editTransactionAmount').value = tx.amount;
      document.getElementById('editTransactionDate').value = tx.date;
      new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
    }
    document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editTransactionId').value;
      const name = document.getElementById('editTransactionName').value;
      const category = document.getElementById('editTransactionCategory').value;
      const amount = parseFloat(document.getElementById('editTransactionAmount').value);
      const date = document.getElementById('editTransactionDate').value;
      let transactions = loadTransactions();
      const index = transactions.findIndex(t => t.id === id);
      if (index >= 0) {
        transactions[index] = { id, name, category, amount, date };
        saveTransactions(transactions);
        renderTransactions();
        let modalEl = document.getElementById('editTransactionModal');
        let modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modalInstance.hide();
      }
    });
    document.getElementById('deleteTransactionBtn').addEventListener('click', function() {
      const id = document.getElementById('editTransactionId').value;
      let transactions = loadTransactions();
      transactions = transactions.filter(tx => tx.id !== id);
      saveTransactions(transactions);
      renderTransactions();
      let modalEl = document.getElementById('editTransactionModal');
      let modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modalInstance.hide();
    });

    // ------------------------------
    // Transaction Form Submission
    // ------------------------------
    document.getElementById('transactionForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('transactionName').value;
      const category = document.getElementById('transactionCategory').value;
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const date = document.getElementById('transactionDate').value;
      const id = Date.now().toString();
      let transactions = loadTransactions();
      transactions.push({ id, name, category, amount, date });
      saveTransactions(transactions);
      renderTransactions();
      this.reset();
    });

    // ------------------------------
    // Month Change Handling
    // ------------------------------
    monthInput.addEventListener('change', () => {
      initBudget();
      renderTransactions();
      createBudgetChart();
    });

    // ------------------------------
    // Initialization on Page Load
    // ------------------------------
    window.addEventListener('DOMContentLoaded', () => {
      initBudget();
      createBudgetChart();
      renderTransactions();
    });
  </script>
</body>
</html>
