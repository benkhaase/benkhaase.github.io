<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Budget Tracker</title>
  <!-- Bootstrap CSS for styling and responsive layout -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Chart.js for interactive charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Global Page Styles */
    body {
      background-color: #fafafa;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    .container-custom {
      max-width: 1100px;
      margin: auto;
    }
    /* Notification area for alerts */
    #notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    /* Authentication Section Styles */
    #auth-section {
      max-width: 500px;
      margin: 20px auto;
    }
    /* Hide main app section until user is logged in */
    #app-section {
      display: none;
    }
    /* Budget Table Styles */
    #budgetTable td:first-child {
      text-align: left;
      padding-left: 15px;
    }
    /* Main Category Row: Bold text, pastel blue background */
    .main-category {
      background-color: #e6f7ff;
      font-weight: bold;
    }
    /* Sub-Category Row: Indented, pastel yellow background, smaller font */
    .subcategory {
      background-color: #fff9e6;
      font-size: 0.9em;
    }
    /* Center text in non-first table cells */
    #budgetTable td:not(:first-child) {
      text-align: center;
    }
    /* Small button styling */
    .small-btn {
      font-size: 0.8rem;
      margin-left: 5px;
    }
    /* Chart container styling */
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      margin-top: 20px;
    }
    .chart-box {
      width: 350px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <!-- Notification Area -->
  <div id="notification"></div>

  <!-- Authentication Section (Login / Signup) -->
  <div class="container-custom mb-3" id="auth-section">
    <!-- Login Form -->
    <div id="login-form" class="card p-3">
      <h4 class="text-center">Login</h4>
      <input type="email" id="login-email" class="form-control my-2" placeholder="Email" required>
      <input type="password" id="login-password" class="form-control my-2" placeholder="Password" required>
      <button id="login-btn" class="btn btn-primary w-100">Login</button>
      <p class="text-center mt-2">Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
    </div>
    <!-- Signup Form -->
    <div id="signup-form" class="card p-3" style="display: none;">
      <h4 class="text-center">Sign Up</h4>
      <input type="email" id="signup-email" class="form-control my-2" placeholder="Email" required>
      <input type="password" id="signup-password" class="form-control my-2" placeholder="Password" required>
      <button id="signup-btn" class="btn btn-success w-100">Sign Up</button>
      <p class="text-center mt-2">Already have an account? <a href="#" id="show-login">Login</a></p>
    </div>
  </div>

  <!-- Main App Section (displayed after login) -->
  <div class="container-custom" id="app-section">
    <!-- Header with Logout -->
    <div class="d-flex justify-content-between align-items-center">
      <h1>Advanced Budget Tracker</h1>
      <button id="logout-btn" class="btn btn-outline-secondary">Logout</button>
    </div>
    <p id="user-info" class="text-end"></p>
    
    <!-- Month Selector -->
    <div class="text-center mb-3">
      <label for="selectedMonth" class="form-label">Select Budget Month:</label>
      <input type="month" id="selectedMonth" class="form-control d-inline-block" style="width: auto;">
    </div>
    
    <!-- Budget Allocations Table -->
    <h2>Budget Allocations</h2>
    <div class="budget-table">
      <table class="table table-bordered text-center" id="budgetTable">
        <thead class="table-dark">
          <tr>
            <th>Category</th>
            <th>Target</th>
            <th>Money Left Over</th>
          </tr>
        </thead>
        <tbody id="budgetTableBody">
          <!-- Budget rows (main and sub-categories) will be generated dynamically -->
        </tbody>
      </table>
    </div>
    
    <!-- Form to Add New Main Category -->
    <div class="mb-4">
      <h4>Add New Main Category</h4>
      <form id="addCategoryForm" class="row g-2">
        <div class="col-md-6">
          <input type="text" id="newCategoryName" class="form-control" placeholder="Category Name" required>
        </div>
        <div class="col-md-4">
          <input type="number" step="0.01" id="newCategoryTarget" class="form-control" placeholder="Target Amount" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Add</button>
        </div>
      </form>
    </div>
    
    <!-- Form to Add New Sub-Category -->
    <div class="mb-4">
      <h4>Add New Sub-Category</h4>
      <form id="addSubCategoryForm" class="row g-2">
        <div class="col-md-4">
          <select id="parentCategory" class="form-select" required>
            <!-- Options populated dynamically with existing main categories -->
          </select>
        </div>
        <div class="col-md-4">
          <input type="text" id="newSubCategoryName" class="form-control" placeholder="Sub-Category Name" required>
        </div>
        <div class="col-md-2">
          <input type="number" step="0.01" id="newSubCategoryTarget" class="form-control" placeholder="Target" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Add</button>
        </div>
      </form>
    </div>
    
    <!-- Transaction Form -->
    <h2>Add a Transaction</h2>
    <div>
      <form id="transactionForm">
        <div class="mb-3">
          <label for="transactionName" class="form-label">Transaction Name</label>
          <input type="text" class="form-control" id="transactionName" placeholder="e.g., Grocery Run" required>
        </div>
        <div class="mb-3">
          <label for="transactionCategory" class="form-label">Category</label>
          <select class="form-select" id="transactionCategory" required>
            <option value="">-- Select Category --</option>
            <!-- Options added dynamically: main categories and "Main > Sub" -->
          </select>
        </div>
        <div class="mb-3">
          <label for="transactionAmount" class="form-label">Amount</label>
          <input type="number" step="0.01" class="form-control" id="transactionAmount" placeholder="e.g., 50.00" required>
        </div>
        <div class="mb-3">
          <label for="transactionDate" class="form-label">Date</label>
          <input type="date" class="form-control" id="transactionDate" required>
        </div>
        <div class="mb-3">
          <label for="transactionNotes" class="form-label">Notes</label>
          <textarea id="transactionNotes" class="form-control" placeholder="Optional notes..."></textarea>
        </div>
        <div class="mb-3">
          <label for="transactionTags" class="form-label">Tags</label>
          <input type="text" id="transactionTags" class="form-control" placeholder="Comma-separated tags">
        </div>
        <button type="submit" class="btn btn-primary">Add Transaction</button>
      </form>
    </div>
    
    <!-- Export/Import & Bank Integration -->
    <div class="mb-3">
      <button id="export-btn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
      <input type="file" id="import-file" class="form-control d-inline-block" style="width: auto;">
      <button id="import-btn" class="btn btn-outline-secondary btn-sm">Import CSV</button>
      <button id="import-bank-btn" class="btn btn-outline-info btn-sm">Import Bank Transactions</button>
    </div>
    
    <!-- Charts Section -->
    <h2>Budget vs. Spent Overview</h2>
    <div class="charts-container">
      <div class="chart-box">
        <canvas id="budgetChart"></canvas>
      </div>
      <div class="chart-box">
        <canvas id="spentChart"></canvas>
      </div>
    </div>
    <h2>Spending Over Time</h2>
    <div class="charts-container">
      <div class="chart-box">
        <canvas id="spentChart3"></canvas>
        <p class="text-center">Past 3 Months</p>
      </div>
      <div class="chart-box">
        <canvas id="spentChart12"></canvas>
        <p class="text-center">Past 12 Months</p>
      </div>
    </div>
    
    <!-- Summaries -->
    <div class="mb-3">
      <h2>Spending Summaries</h2>
      <p><strong>This Month’s Total Spent:</strong> $<span id="monthlySpent">0.00</span></p>
      <p><strong>This Year’s Total Spent:</strong> $<span id="yearlySpent">0.00</span></p>
    </div>
    
    <!-- Transaction History Table -->
    <div>
      <h2>Transaction History</h2>
      <table class="table table-striped" id="transactionsTable">
        <thead class="table-dark">
          <tr>
            <th>Transaction Name</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Notes/Tags</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Transaction rows generated dynamically -->
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Category Transactions Modal (for viewing transactions in a specific category) -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">Transactions for Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-striped" id="categoryTransactionsTable">
            <thead class="table-dark">
              <tr>
                <th>Transaction Name</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Notes/Tags</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Category-specific transactions inserted dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Transaction Modal -->
  <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editTransactionForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Hidden field for transaction ID -->
            <input type="hidden" id="editTransactionId">
            <div class="mb-3">
              <label for="editTransactionName" class="form-label">Transaction Name</label>
              <input type="text" class="form-control" id="editTransactionName" required>
            </div>
            <div class="mb-3">
              <label for="editTransactionCategory" class="form-label">Category</label>
              <select class="form-select" id="editTransactionCategory" required>
                <!-- Options generated dynamically -->
              </select>
            </div>
            <div class="mb-3">
              <label for="editTransactionAmount" class="form-label">Amount</label>
              <input type="number" step="0.01" class="form-control" id="editTransactionAmount" required>
            </div>
            <div class="mb-3">
              <label for="editTransactionDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="editTransactionDate" required>
            </div>
            <div class="mb-3">
              <label for="editTransactionNotes" class="form-label">Notes</label>
              <textarea id="editTransactionNotes" class="form-control"></textarea>
            </div>
            <div class="mb-3">
              <label for="editTransactionTags" class="form-label">Tags</label>
              <input type="text" id="editTransactionTags" class="form-control" placeholder="Comma-separated tags">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" id="deleteTransactionBtn" class="btn btn-danger">Delete Transaction</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Main JavaScript using ES6 Modules -->
  <script type="module">
    /**********************************
     * Firebase Initialization & Configuration
     **********************************/
    // Import Firebase modules from the modular SDK.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    
    // Firebase configuration (using your provided credentials)
    const firebaseConfig = {
      apiKey: "AIzaSyA20mW5oI1ay681o5L9gY21LFGcjcB9wfc",
      authDomain: "budget-tracker-7a9a4.firebaseapp.com",
      projectId: "budget-tracker-7a9a4",
      storageBucket: "budget-tracker-7a9a4.firebasestorage.app",
      messagingSenderId: "414594370996",
      appId: "1:414594370996:web:8d29f1efccbd98de0536e1"
    };
    
    // Initialize Firebase app, authentication, and Firestore.
    const appFirebase = initializeApp(firebaseConfig);
    const auth = getAuth(appFirebase);
    const db = getFirestore(appFirebase);
    
    /**********************************
     * Authentication Logic & UI
     **********************************/
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const showSignupLink = document.getElementById("show-signup");
    const showLoginLink = document.getElementById("show-login");
    const loginBtn = document.getElementById("login-btn");
    const signupBtn = document.getElementById("signup-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userInfoEl = document.getElementById("user-info");
    const authSection = document.getElementById("auth-section");
    const appSection = document.getElementById("app-section");
    
    // Toggle between login and signup forms.
    showSignupLink.addEventListener("click", (e) => {
      e.preventDefault();
      loginForm.style.display = "none";
      signupForm.style.display = "block";
    });
    showLoginLink.addEventListener("click", (e) => {
      e.preventDefault();
      signupForm.style.display = "none";
      loginForm.style.display = "block";
    });
    
    // Login event handler.
    loginBtn.addEventListener("click", () => {
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log("Logged in:", userCredential.user);
        })
        .catch((error) => {
          alert("Login error: " + error.message);
        });
    });
    
    // Signup event handler.
    signupBtn.addEventListener("click", () => {
      const email = document.getElementById("signup-email").value;
      const password = document.getElementById("signup-password").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log("Signed up:", userCredential.user);
        })
        .catch((error) => {
          alert("Signup error: " + error.message);
        });
    });
    
    // Logout event handler.
    logoutBtn.addEventListener("click", () => {
      signOut(auth)
        .then(() => {
          console.log("User logged out");
        })
        .catch((error) => {
          alert("Logout error: " + error.message);
        });
    });
    
    // Listen for authentication state changes.
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userInfoEl.textContent = "Logged in as: " + user.email;
        authSection.style.display = "none";
        appSection.style.display = "block";
        // After login, load budgeting data.
        initBudget().then(renderTransactions).then(updateCharts);
      } else {
        userInfoEl.textContent = "";
        authSection.style.display = "block";
        appSection.style.display = "none";
      }
    });
    
    /**********************************
     * Global Budget Presets & Data Structures
     **********************************/
    // Default budget structure with preset main categories and sub-categories.
    const defaultBudget = [
      { 
        category: "Housing", allocation: 2300, 
        subcategories: [
          { category: "Mortgage", allocation: 1631.82 },
          { category: "HOA", allocation: 486.56 },
          { category: "Electric", allocation: 63.26 },
          { category: "Wifi", allocation: 55.00 }
        ]
      },
      { 
        category: "Debt", allocation: 720, 
        subcategories: [
          { category: "Bens Student Loans", allocation: 269.19 },
          { category: "White Car", allocation: 450 }
        ]
      },
      { 
        category: "Insurance", allocation: 90, 
        subcategories: [
          { category: "White Car", allocation: 121.00 }
        ]
      },
      { category: "Charging", allocation: 160, subcategories: [] },
      { category: "Groceries", allocation: 400, subcategories: [] },
      { category: "Restaurants", allocation: 200, subcategories: [] },
      { category: "Shopping", allocation: 100, subcategories: [] },
      { 
        category: "Subscriptions", allocation: 250, 
        subcategories: [
          { category: "Spotify", allocation: 19.99 },
          { category: "FSD", allocation: 107.00 },
          { category: "icloud", allocation: 2.99 },
          { category: "Yoga", allocation: 119.00 }
        ]
      },
      { category: "House Fund", allocation: 100, subcategories: [] },
      { category: "Maya Fund", allocation: 100, subcategories: [] },
      { category: "Ben Fund", allocation: 100, subcategories: [] },
      { category: "Misc", allocation: 200, subcategories: [] }
    ];
    
    // Global variables to store current budget state.
    let budgetDataGlobal = [];  // Hierarchical data for the current month.
    let spentData = {};         // Tracks spending for main and subcategories.
    let allocationsGlobal = {}; // Mapping of current target amounts.
    
    // DOM references for budget table and transaction category dropdowns.
    const budgetTableBody = document.getElementById("budgetTableBody");
    const transactionCategorySelect = document.getElementById("transactionCategory");
    const editTransactionCategorySelect = document.getElementById("editTransactionCategory");
    
    /**********************************
     * Firestore Data Persistence Functions
     **********************************/
    // Helper: Get current user's document reference.
    function getUserDocRef() {
      return db.collection("users").doc(auth.currentUser.uid);
    }
    
    // Load budget targets for the current month from Firestore.
    async function loadBudgetTargets() {
      const key = "budgetTargets_" + monthInput.value;
      const docRef = getUserDocRef().collection("budgets").doc(key);
      const docSnap = await docRef.get();
      if (docSnap.exists) {
        return docSnap.data();
      } else {
        // Build default structure.
        let structure = {};
        defaultBudget.forEach(item => {
          if (item.subcategories && item.subcategories.length > 0) {
            structure[item.category] = {};
            item.subcategories.forEach(sub => {
              structure[item.category][sub.category] = sub.allocation;
            });
          } else {
            structure[item.category] = item.allocation;
          }
        });
        return structure;
      }
    }
    
    // Save budget targets for the current month to Firestore.
    async function saveBudgetTargets(structure) {
      const key = "budgetTargets_" + monthInput.value;
      return getUserDocRef().collection("budgets").doc(key).set(structure);
    }
    
    // Load transactions for the current month from Firestore.
    async function loadTransactions() {
      const key = "transactions_" + monthInput.value;
      const snapshot = await getUserDocRef().collection("transactions").get();
      let txs = [];
      snapshot.forEach(doc => { txs.push(doc.data()); });
      return txs;
    }
    
    // Save a transaction to Firestore.
    async function saveTransaction(transaction) {
      return getUserDocRef().collection("transactions").doc(transaction.id).set(transaction);
    }
    
    // Delete a transaction from Firestore.
    async function deleteTransactionFromDB(id) {
      return getUserDocRef().collection("transactions").doc(id).delete();
    }
    
    /**********************************
     * UI Rendering: Budget Table
     **********************************/
    async function initBudget() {
      const stored = await loadBudgetTargets();
      // Merge defaults with stored targets to build our hierarchical structure.
      budgetDataGlobal = [];
      defaultBudget.forEach(item => {
        if (typeof stored[item.category] === "number") {
          budgetDataGlobal.push({ category: item.category, target: parseFloat(stored[item.category]), subcategories: [] });
        } else if (typeof stored[item.category] === "object") {
          let subcats = [];
          let sum = 0;
          for (const sub in stored[item.category]) {
            const val = parseFloat(stored[item.category][sub]);
            subcats.push({ category: sub, target: val });
            sum += val;
          }
          budgetDataGlobal.push({ category: item.category, target: sum, subcategories: subcats });
        } else {
          if (item.subcategories && item.subcategories.length > 0) {
            let subcats = [];
            let sum = 0;
            item.subcategories.forEach(sub => {
              subcats.push({ category: sub.category, target: sub.allocation });
              sum += sub.allocation;
            });
            budgetDataGlobal.push({ category: item.category, target: sum, subcategories: subcats });
          } else {
            budgetDataGlobal.push({ category: item.category, target: item.allocation, subcategories: [] });
          }
        }
      });
      
      // Clear budget table and dropdowns.
      budgetTableBody.innerHTML = "";
      transactionCategorySelect.innerHTML = '<option value="">-- Select Category --</option>';
      editTransactionCategorySelect.innerHTML = '<option value="">-- Select Category --</option>';
      
      // Reset spending data.
      spentData = {};
      
      // Loop through each main category.
      budgetDataGlobal.forEach(main => {
        allocationsGlobal[main.category] = main.target;
        // Create main category row.
        const mainRow = document.createElement("tr");
        mainRow.classList.add("main-category");
        mainRow.innerHTML = `
          <td class="clickable">${main.category}</td>
          <td>$${main.target.toFixed(2)}</td>
          <td id="leftover-${main.category}">$${main.target.toFixed(2)}</td>
        `;
        // Clicking main category shows its transactions (including sub-categories)
        mainRow.cells[0].addEventListener("click", () => showCategoryTransactions(main.category));
        budgetTableBody.appendChild(mainRow);
        leftoverCells[main.category] = mainRow.cells[2];
        addOptionToSelect(transactionCategorySelect, main.category);
        addOptionToSelect(editTransactionCategorySelect, main.category);
        
        // Create rows for each sub-category if present.
        if (main.subcategories && main.subcategories.length > 0) {
          main.subcategories.forEach(sub => {
            const key = `${main.category} > ${sub.category}`;
            allocationsGlobal[key] = sub.target;
            const subRow = document.createElement("tr");
            subRow.classList.add("subcategory");
            subRow.innerHTML = `
              <td class="clickable">${sub.category} 
                <button class="btn btn-primary btn-sm small-btn" onclick="autoAddSubCategory('${main.category}', '${sub.category}', ${sub.target})">Auto Add</button>
              </td>
              <td>$${sub.target.toFixed(2)}</td>
              <td id="leftover-${key}">$${sub.target.toFixed(2)}</td>
            `;
            // Clicking sub-category shows its transactions.
            subRow.cells[0].addEventListener("click", () => showCategoryTransactions(key));
            budgetTableBody.appendChild(subRow);
            leftoverCells[key] = subRow.cells[2];
            addOptionToSelect(transactionCategorySelect, key);
            addOptionToSelect(editTransactionCategorySelect, key);
          });
        }
      });
      
      // Append Totals row for main categories.
      const totalsRow = document.createElement("tr");
      totalsRow.id = "totalsRow";
      const totalAllocations = budgetDataGlobal.reduce((sum, main) => sum + main.target, 0);
      totalsRow.innerHTML = `
        <td>Totals</td>
        <td>$${totalAllocations.toFixed(2)}</td>
        <td id="totalsLeftover">$${totalAllocations.toFixed(2)}</td>
      `;
      budgetTableBody.appendChild(totalsRow);
      totalsAllocCell = totalsRow.cells[1];
      totalsLeftoverCell = totalsRow.cells[2];
    }
    
    // Helper: Add an option to a select element.
    function addOptionToSelect(selectElem, category) {
      if (![...selectElem.options].some(opt => opt.value === category)) {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        selectElem.appendChild(option);
      }
    }
    
    /**********************************
     * Editing Budget Targets
     **********************************/
    // If subCategory is null, edit the main category; otherwise, edit the sub-category.
    function editBudgetTarget(mainCategory, subCategory) {
      if (subCategory === null) {
        const mainObj = budgetDataGlobal.find(item => item.category === mainCategory);
        const current = mainObj.target;
        const newVal = prompt(`Enter new target for ${mainCategory}:`, current);
        if (newVal !== null) {
          const parsed = parseFloat(newVal);
          if (!isNaN(parsed) && parsed >= 0) {
            mainObj.target = parsed;
            // Save updated main category target to Firestore.
            const stored = {};
            stored[mainCategory] = parsed;
            saveBudgetTargets(stored);
            renderTransactions().then(initBudget);
          } else alert("Please enter a valid number.");
        }
      } else {
        const mainObj = budgetDataGlobal.find(item => item.category === mainCategory);
        if (!mainObj || !mainObj.subcategories) return;
        const subObj = mainObj.subcategories.find(s => s.category === subCategory);
        const current = subObj.target;
        const newVal = prompt(`Enter new target for ${mainCategory} > ${subCategory}:`, current);
        if (newVal !== null) {
          const parsed = parseFloat(newVal);
          if (!isNaN(parsed) && parsed >= 0) {
            subObj.target = parsed;
            // Recalculate the main category target.
            const newMainTotal = mainObj.subcategories.reduce((sum, s) => sum + s.target, 0);
            mainObj.target = newMainTotal;
            const stored = {};
            if (typeof stored[mainCategory] === "object") {
              stored[mainCategory][subCategory] = parsed;
            } else {
              stored[mainCategory] = { [subCategory]: parsed };
            }
            saveBudgetTargets(stored);
            renderTransactions().then(initBudget);
          } else alert("Please enter a valid number.");
        }
      }
    }
    
    /**********************************
     * Auto Add Transaction for Sub-Category
     **********************************/
    // This function creates a new transaction for the full target amount of a sub-category.
    function autoAddSubCategory(mainCat, subCat, amount) {
      const today = new Date().toISOString().split("T")[0];
      const transaction = {
        id: Date.now().toString(),
        name: `Auto: ${subCat}`,
        category: `${mainCat} > ${subCat}`,
        amount: amount,
        date: today,
        notes: "",
        tags: ""
      };
      saveTransaction(transaction).then(() => {
        renderTransactions();
        alert(`Auto transaction for ${mainCat} > ${subCat} of $${amount.toFixed(2)} added.`);
      });
    }
    
    /**********************************
     * Rendering Transactions & Updating Charts
     **********************************/
    async function renderTransactions() {
      const txs = await loadTransactions();
      
      // Reset spending data.
      budgetDataGlobal.forEach(main => {
        spentData[main.category] = 0;
        if (main.subcategories) {
          main.subcategories.forEach(sub => {
            spentData[`${main.category} > ${sub.category}`] = 0;
          });
        }
      });
      
      // Build the Transaction History Table.
      const txTableBody = document.getElementById("transactionsTable").querySelector("tbody");
      txTableBody.innerHTML = "";
      txs.forEach(tx => {
        const txCat = tx.category;
        const mainCat = txCat.includes(" > ") ? txCat.split(" > ")[0] : txCat;
        if (!spentData[mainCat]) spentData[mainCat] = 0;
        spentData[mainCat] += tx.amount;
        if (txCat.includes(" > ")) {
          if (!spentData[txCat]) spentData[txCat] = 0;
          spentData[txCat] += tx.amount;
        }
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${tx.name}</td>
          <td>${tx.category}</td>
          <td>$${tx.amount.toFixed(2)}</td>
          <td>${tx.date}</td>
          <td>${tx.notes} ${tx.tags}</td>
          <td><button class="btn btn-secondary btn-sm small-btn" onclick="openEditTransactionModal('${tx.id}')">Edit</button></td>
        `;
        txTableBody.appendChild(row);
      });
      
      // Update leftover values in the budget table.
      budgetDataGlobal.forEach(main => {
        const mainSpent = spentData[main.category] || 0;
        const mainLeftover = main.target - mainSpent;
        if (leftoverCells[main.category]) {
          leftoverCells[main.category].textContent = `$${mainLeftover.toFixed(2)}`;
          leftoverCells[main.category].classList.toggle("over-budget", mainLeftover < 0);
        }
        if (main.subcategories) {
          main.subcategories.forEach(sub => {
            const key = `${main.category} > ${sub.category}`;
            const subSpent = spentData[key] || 0;
            const subLeftover = sub.target - subSpent;
            if (leftoverCells[key]) {
              leftoverCells[key].textContent = `$${subLeftover.toFixed(2)}`;
              leftoverCells[key].classList.toggle("over-budget", subLeftover < 0);
            }
          });
        }
      });
      
      // Update Totals row.
      let totalTarget = 0, totalLeftover = 0;
      budgetDataGlobal.forEach(main => {
        totalTarget += main.target;
        totalLeftover += main.target - (spentData[main.category] || 0);
      });
      totalsAllocCell.textContent = `$${totalTarget.toFixed(2)}`;
      totalsLeftoverCell.textContent = `$${totalLeftover.toFixed(2)}`;
      
      // Update charts.
      updateCharts();
    }
    
    /**********************************
     * Chart.js Functions
     **********************************/
    let budgetChart, spentChart, spentChart3, spentChart12;
    
    function updateCharts() {
      createBudgetChart();
      createSpentChart();
      createSpentChart3();
      createSpentChart12();
    }
    
    function createBudgetChart() {
      const ctxBudget = document.getElementById("budgetChart").getContext("2d");
      if (budgetChart) budgetChart.destroy();
      const labels = budgetDataGlobal.map(main => main.category);
      const dataAllocations = budgetDataGlobal.map(main => main.target);
      budgetChart = new Chart(ctxBudget, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "Budget Allocation",
            data: dataAllocations,
            backgroundColor: [
              "#a2d5f2", "#ffb3ba", "#ffdfba", "#ffffba",
              "#baffc9", "#bae1ff", "#fbc4ab", "#f6eac2",
              "#c1c8e4", "#d4a5a5", "#f5d0a9", "#b8e0d2"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: { display: true, text: "Budget Distribution (Targets)" }
          }
        }
      });
    }
    
    function createSpentChart() {
      const ctxSpent = document.getElementById("spentChart").getContext("2d");
      if (spentChart) spentChart.destroy();
      const labels = budgetDataGlobal.map(main => main.category);
      const dataSpent = budgetDataGlobal.map(main => spentData[main.category] || 0);
      spentChart = new Chart(ctxSpent, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "Spent (This Month)",
            data: dataSpent,
            backgroundColor: [
              "#a2d5f2", "#ffb3ba", "#ffdfba", "#ffffba",
              "#baffc9", "#bae1ff", "#fbc4ab", "#f6eac2",
              "#c1c8e4", "#d4a5a5", "#f5d0a9", "#b8e0d2"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: { display: true, text: "Spent Distribution (This Month)" }
          }
        }
      });
    }
    
    // For simplicity, the charts for past 3 and 12 months use the current spending data as a placeholder.
    function createSpentChart3() {
      const ctx3 = document.getElementById("spentChart3").getContext("2d");
      if (spentChart3) spentChart3.destroy();
      const labels = budgetDataGlobal.map(main => main.category);
      const dataSpent = labels.map(cat => spentData[cat] || 0);
      spentChart3 = new Chart(ctx3, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "Spent (Past 3 Months)",
            data: dataSpent,
            backgroundColor: [
              "#a2d5f2", "#ffb3ba", "#ffdfba", "#ffffba",
              "#baffc9", "#bae1ff", "#fbc4ab", "#f6eac2",
              "#c1c8e4", "#d4a5a5", "#f5d0a9", "#b8e0d2"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: { display: true, text: "Spent Distribution (Past 3 Months)" }
          }
        }
      });
    }
    
    function createSpentChart12() {
      const ctx12 = document.getElementById("spentChart12").getContext("2d");
      if (spentChart12) spentChart12.destroy();
      const labels = budgetDataGlobal.map(main => main.category);
      const dataSpent = labels.map(cat => spentData[cat] || 0);
      spentChart12 = new Chart(ctx12, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "Spent (Past 12 Months)",
            data: dataSpent,
            backgroundColor: [
              "#a2d5f2", "#ffb3ba", "#ffdfba", "#ffffba",
              "#baffc9", "#bae1ff", "#fbc4ab", "#f6eac2",
              "#c1c8e4", "#d4a5a5", "#f5d0a9", "#b8e0d2"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            title: { display: true, text: "Spent Distribution (Past 12 Months)" }
          }
        }
      });
    }
    
    /**********************************
     * Notification Helper Function
     **********************************/
    function showNotification(message, type = "info") {
      const notif = document.getElementById("notification");
      notif.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => { notif.innerHTML = ""; }, 4000);
    }
    
    /**********************************
     * Export/Import Functions (Placeholders)
     **********************************/
    function exportCSV() {
      // Placeholder for CSV export.
      showNotification("Export CSV functionality is not implemented.", "warning");
    }
    function importCSV(file) {
      // Placeholder for CSV import.
      showNotification("Import CSV functionality is not implemented.", "warning");
    }
    
    document.getElementById("export-btn").addEventListener("click", exportCSV);
    document.getElementById("import-btn").addEventListener("click", () => {
      const file = document.getElementById("import-file").files[0];
      if (file) importCSV(file);
    });
    document.getElementById("import-bank-btn").addEventListener("click", () => {
      showNotification("Bank transaction import is not implemented.", "warning");
    });
    
    /**********************************
     * Edit Transaction Modal Functions
     **********************************/
    function openEditTransactionModal(id) {
      loadTransactions().then(txs => {
        let tx = txs.find(t => t.id === id);
        if (!tx) return;
        document.getElementById("editTransactionId").value = tx.id;
        document.getElementById("editTransactionName").value = tx.name;
        document.getElementById("editTransactionCategory").value = tx.category;
        document.getElementById("editTransactionAmount").value = tx.amount;
        document.getElementById("editTransactionDate").value = tx.date;
        document.getElementById("editTransactionNotes").value = tx.notes || "";
        document.getElementById("editTransactionTags").value = tx.tags || "";
        new bootstrap.Modal(document.getElementById("editTransactionModal")).show();
      });
    }
    
    document.getElementById("editTransactionForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editTransactionId").value;
      const name = document.getElementById("editTransactionName").value;
      const category = document.getElementById("editTransactionCategory").value;
      const amount = parseFloat(document.getElementById("editTransactionAmount").value);
      const date = document.getElementById("editTransactionDate").value;
      const notes = document.getElementById("editTransactionNotes").value;
      const tags = document.getElementById("editTransactionTags").value;
      const transaction = { id, name, category, amount, date, notes, tags };
      await saveTransaction(transaction);
      await renderTransactions();
      bootstrap.Modal.getInstance(document.getElementById("editTransactionModal")).hide();
    });
    
    document.getElementById("deleteTransactionBtn").addEventListener("click", async () => {
      const id = document.getElementById("editTransactionId").value;
      await deleteTransactionFromDB(id);
      await renderTransactions();
      bootstrap.Modal.getInstance(document.getElementById("editTransactionModal")).hide();
    });
    
    /**********************************
     * Transaction Form Submission
     **********************************/
    document.getElementById("transactionForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("transactionName").value;
      const category = document.getElementById("transactionCategory").value;
      const amount = parseFloat(document.getElementById("transactionAmount").value);
      const date = document.getElementById("transactionDate").value;
      const notes = document.getElementById("transactionNotes").value;
      const tags = document.getElementById("transactionTags").value;
      const id = Date.now().toString();
      const transaction = { id, name, category, amount, date, notes, tags };
      await saveTransaction(transaction);
      await renderTransactions();
      e.target.reset();
    });
    
    /**********************************
     * Month Change Listener
     **********************************/
    document.getElementById("selectedMonth").addEventListener("change", async () => {
      await initBudget();
      await renderTransactions();
      updateCharts();
    });
    
    /**********************************
     * Initialization on Page Load
     **********************************/
    window.addEventListener("DOMContentLoaded", async () => {
      if (auth.currentUser) {
        await initBudget();
        await renderTransactions();
        updateCharts();
      }
    });
    
    /**********************************
     * Global Helper: Show Notification
     **********************************/
    function showNotification(message, type = "info") {
      const notif = document.getElementById("notification");
      notif.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => { notif.innerHTML = ""; }, 4000);
    }
  </script>
</body>
</html>
